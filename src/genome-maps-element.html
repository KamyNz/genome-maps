<script src="../lib/jsorolla/src/lib/utils.js"></script>
<script src="../lib/jsorolla/src/lib/opencga-manager.js"></script>
<script src="../lib/jsorolla/src/lib/cellbase-manager.js"></script>
<script src="eva-adapter.js"></script>
<script src="eva-manager.js"></script>


<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">


<link rel="import" href="../lib/jsorolla/src/lib/components/jso-panel.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-header.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-footer.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-help-menu.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-upload-variant-file.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-browser.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/jso-genome-viewer-element.html">

<link rel="import" href="components/gm-track-menu.html">
<link rel="import" href="components/gm-search.html">
<link rel="import" href="components/gm-add-track.html">
<link rel="import" href="components/gm-status-bar.html">

<dom-module id="genome-maps-element">
    <style>
        :host {
            display: block;
            position: relative;
            cursor: default;
            font-size: 13px;
            background-color: var(--light-primary-color);
            height: 100%;
        }

        #sidemenu {
            background-color: var(--default-primary-color);
            color: var(--text-primary-color);
        }

        #sidemenu > div {
            font-size: 20px;
            box-sizing: border-box;
            padding: 7px 20px;
            border-bottom: 1px solid var(--divider-color);
        }

        #sidemenu > div:hover {
            cursor: pointer;
            background-color: var(--accent-color);
        }

        #sidemenu > div[active] {
            font-weight: normal;
        }

        #menu > div {
            box-sizing: border-box;
            margin-right: 1vw;
            cursor: pointer;
            text-align: center;
            line-height: 30px;
            margin-top: 15px;
            margin-bottom: 15px;
            padding: 0 5px;
        }

        div.icon {
            margin-left: 15px;
        }

        div.menu-button {
            padding:0 10px;
        }
        div.menu-button:hover {
            background-color: rgba(0, 0, 0, 0.20);
        }

        .menu > div[active] {
            border-bottom: 2px solid var(--accent-color);
        }

        #content {
            background-color: inherit;
        }

        gm-status-bar {
            height: 30px;
            padding: 4px;
            border-top: 1px solid rgba(125, 125, 125, 0.3);
        }

        jso-genome-viewer-element {
            height: calc(100vh - 90px);
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
        }

        jso-opencga-upload-file {
            box-sizing: border-box;
            padding: 20px 30px;
        }

        #browserPanel {
            position: absolute;
            top: 60px;
            left: 0;
            width: 600px;
        }

        #browser {
            /*width: 600px;*/
            height: 400px;
        }

        #trackMenuPanel {
            box-shadow: 0px 0px 6px 3px rgba(0, 0, 0, 0.30);
        }

        #cellbaseTrackPanel {
            box-shadow: 0px 0px 6px 3px rgba(0, 0, 0, 0.30);
        }

        #cellbaseSearchPanel {
            box-shadow: 0px 0px 6px 3px rgba(0, 0, 0, 0.30);
        }

        #configure {
            position: absolute;
            top: 60px;
            right: 0;
            width: 300px;
        }

        @media (max-width: 1100px) {
            .option-text {
                display: none;
            }
        }

    </style>
    <template>
        <paper-drawer-panel id="paperDrawerPanel" force-narrow>
            <div drawer id="sidemenu">
                <div title="Upload" class="hover" on-click="handleToggleUpload" data-panel="uploadPanel">
                    <i class="fa fa-cloud-upload"></i>
                    <span>Upload</span>
                </div>
                <div title="Browse" class="hover" on-click="handleToggleBrowser" data-panel="browserPanel">
                    <i class="fa fa-folder-open"></i>
                    <span>Browse</span>
                </div>
                <div title="Tracks" class="hover" on-click="handleToggleTrackMenuPanel" data-panel="trackMenuPanel">
                    <i class="fa fa-tasks"></i>
                    <span>Tracks</span>
                </div>
                <div title="CellBase" class="hover" on-click="handleToggleCellbaseTrackPanel" data-panel="cellbaseTrackPanel">
                    <i class="fa fa-database"></i>
                    <span>CellBase</span>
                </div>
                <div title="Search" class="hover" on-click="handleToggleCellbaseSearchPanel" data-panel="cellbaseSearchPanel">
                    <i class="fa fa-search"></i>
                    <span>Search</span>
                </div>
            </div>
            <div main>
                <jso-header id="jsoHeader"
                            selected-option="{{selectedOption}}"
                            user-data="{{userData}}"
                            on-login="handleLogin"
                            on-logout="handleLogout"
                        >
                    <div class="menu-button" paper-drawer-toggle>
                        <i class="fa fa-bars" paper-drawer-toggle></i>
                    </div>
                    <!--<div hidden class="icon">-->
                    <!--<img src="" style="height: 0px;margin: 5px 0px 0 0;">-->
                    <!--</div>-->
                    <span class="title">Genome Maps</span>
                    <!--<span id="description" class="description"></span>-->

                    <div id="menu" class="menu horizontal layout">
                        <div title="Upload" class="hover" on-click="handleToggleUpload" data-panel="uploadPanel">
                            <i class="fa fa-cloud-upload"></i>
                            <span class="option-text">Upload</span>
                        </div>
                        <div title="Browse" class="hover" on-click="handleToggleBrowser" data-panel="browserPanel">
                            <i class="fa fa-folder-open"></i>
                            <span class="option-text">Browse</span>
                        </div>
                        <div title="Tracks" class="hover" on-click="handleToggleTrackMenuPanel" data-panel="trackMenuPanel">
                            <i class="fa fa-tasks"></i>
                            <span class="option-text">Tracks</span>
                        </div>
                        <div title="CellBase" class="hover" on-click="handleToggleCellbaseTrackPanel" data-panel="cellbaseTrackPanel">
                            <i class="fa fa-database"></i>
                            <span class="option-text">CellBase</span>
                        </div>
                        <div title="Search" class="hover" on-click="handleToggleCellbaseSearchPanel" data-panel="cellbaseSearchPanel">
                            <i class="fa fa-search"></i>
                            <span class="option-text">Search</span>
                        </div>
                    </div>

                    <jso-help-menu class="helpmenu" selectedOption="{{selectedOption}}">
                        <a href="https://github.com/opencb/genome-maps/wiki" target="_blank">
                            <i class="fa fa-book"></i>
                            &nbsp; Documentation
                        </a>
                        <a href="https://github.com/opencb/genome-maps/" target="_blank">
                            <i class="fa fa-github"></i>
                            &nbsp; Source code
                        </a>
                    </jso-help-menu>
                </jso-header>


                <div id="content">
                    <jso-genome-viewer-element id="gv" menu-option="home"></jso-genome-viewer-element>


                    <div id="configure">

                        <jso-panel collapsible id="trackMenuPanel" on-hidden="handlePanelHidden">
                            <div class="header">
                                Active tracks
                            </div>
                            <div class="container flex">
                                <gm-track-menu
                                        id="trackMenu"
                                        on-swap="handleSwapTrackMenu"
                                        on-removetrack="handleRemoveTrack"></gm-track-menu>
                            </div>
                        </jso-panel>


                        <jso-panel collapsible id="cellbaseTrackPanel" on-hidden="handlePanelHidden">
                            <div class="header">
                                Add CellBase tracks
                            </div>
                            <div class="container flex">
                                <gm-add-track
                                        id="addTrack"
                                        on-addtrack="handleAddTrack"
                                        selectedSpecies="{{selectedSpecies}}"
                                        collapsed="true"></gm-add-track>
                            </div>
                        </jso-panel>


                        <jso-panel collapsible id="cellbaseSearchPanel" on-hidden="handlePanelHidden">
                            <div class="header">
                                Advanced Cellbase search
                            </div>

                            <div class="container flex">
                                <gm-search
                                        id="search"
                                        selected-species="{{selectedSpecies}}"
                                        collapsed="true"
                                        on-feature="handleResultClick"></gm-search>
                            </div>
                        </jso-panel>
                    </div>

                    <jso-panel hidden collapsible movable closable id="browserPanel" on-hidden="handlePanelHidden">
                        <div class="header">
                            Browse
                        </div>
                        <div class="container flex">
                            <jso-opencga-browser
                                    id="browser"
                                    on-fileselect="handleFileSelect"
                                    bioformats="{{bioformats}}"
                                    projects="{{projects}}"
                                    on-need-refresh="handleUserNeedRefresh"></jso-opencga-browser>
                        </div>
                    </jso-panel>


                    <jso-panel modal closable hidden id="uploadPanel" on-hidden="handlePanelHidden">
                        <div class="header">
                            <i class="fa fa-cloud-upload"></i> &nbsp; Upload file
                        </div>
                        <div class="container" id="uploadFile">
                            <jso-opencga-upload-file
                                    bioformats="{{bioformats}}"
                                    projects="{{projects}}"
                                    ></jso-opencga-upload-file>
                        </div>
                    </jso-panel>

                </div>
                <gm-status-bar
                        menu-option="home"
                        id="statusBar"
                        version="{{version}}">
                    <span style="color:#666">created by Computational Genomics Department, Principe Felipe Research Center, 2015</span>
                </gm-status-bar>


            </div>
        </paper-drawer-panel>


    </template>
</dom-module>
<script>
    Polymer({
        is: "genome-maps-element",
        properties: {
            version: {
                type: String,
                reflectToAttribute: true
            },
            selectedOption: {
                type: String,
                value: "home",
                notify: true,
                reflectToAttribute: true,
                observer: 'selectedOptionChanged'
            },
            selectedSpecies: {
                type: Object
            },
            userData: {
                type: Object,
                notify: true,
                observer: 'userDataChanged'
            },
            projects: {
                type: Array,
                notify: true
            },
            bioformats: {
                type: Array,
                notify: true,
                value: ['ALIGNMENT', 'VARIANT']
            }
        },
        ready: function () {
            var panels = Polymer.dom(this.root).querySelectorAll('jso-panel');
            for (var i = 0; i < panels.length; i++) {
                var panEl = panels[i];
                var id = panEl.getAttribute('id');
                var el = Polymer.dom(this.$.menu).querySelector('[data-panel=' + id + ']');
                if (el) {
                    if (panEl.hidden) {
                        el.removeAttribute('active')
                    } else {
                        el.setAttribute('active', '');
                    }
                }
                var el = Polymer.dom(this.$.sidemenu).querySelector('[data-panel=' + id + ']');
                if (el) {
                    if (panEl.hidden) {
                        el.removeAttribute('active')
                    } else {
                        el.setAttribute('active', '');
                    }
                }
            }

            this._init();
        },

        selectedOptionChanged: function (neo, old) {
            var menuItems = Polymer.dom(this.root).querySelectorAll('[menu-option]');
            for (var i = 0; i < menuItems.length; i++) {
                var item = menuItems[i];
                var currentItemValue = item.getAttribute("menu-option");
                if (neo == currentItemValue) {
                    item.removeAttribute("hidden");
                } else {
                    item.setAttribute('hidden', '');
                }
            }
        },
        handleMenu: function (e) {
            var option = e.currentTarget.dataset['option'];
            this.setMenu(option);
        },
        setMenu: function (option) {
            if (option) {
                this.selectedOption = option;
            }
        },

        handleToggleBrowser: function (e) {
            this.$.paperDrawerPanel.closeDrawer();
            if (this.$.jsoHeader.isLogged) {
                this.$.browserPanel.hidden = !this.$.browserPanel.hidden;
            } else {
                this.selectedOption = 'login';
                this._lastLogedRequest = this.$.browserPanel;
            }
        },
        handleToggleUpload: function (e) {
            this.$.paperDrawerPanel.closeDrawer();
            if (this.$.jsoHeader.isLogged) {
                this.$.uploadPanel.hidden = !this.$.uploadPanel.hidden;
            } else {
                this.selectedOption = 'login';
                this._lastLogedRequest = this.$.uploadPanel;
            }
        },
        handleToggleTrackMenuPanel: function (e) {
            this.$.trackMenuPanel.hidden = !this.$.trackMenuPanel.hidden;
        },
        handleToggleCellbaseTrackPanel: function (e) {
            this.$.cellbaseTrackPanel.hidden = !this.$.cellbaseTrackPanel.hidden;
        },
        handleToggleCellbaseSearchPanel: function (e) {
            this.$.cellbaseSearchPanel.hidden = !this.$.cellbaseSearchPanel.hidden;
        },
        handlePanelHidden: function (e) {
            var id = e.currentTarget.getAttribute('id');
            var sel = '[data-panel=' + id + ']';
            var el = Polymer.dom(this.$.menu).querySelector(sel);
            if (e.currentTarget.hidden) {
                el.removeAttribute('active')
            } else {
                el.setAttribute('active', '');
            }
            var el = Polymer.dom(this.$.sidemenu).querySelector(sel);
            if (e.currentTarget.hidden) {
                el.removeAttribute('active')
            } else {
                el.setAttribute('active', '');
            }
        },

        handleRemoveTrack: function (e) {
            this.genomeViewer.removeTrack(e.detail);
        },
        handleFileSelect: function (e) {
            console.log("file");
            console.log(e.detail);
            var file = e.detail;
            if (file.index && file.index.status == 'READY') {
                var track = this.addTrack(file.bioformat, file.name, file);
            }
        },
        _updateTrackMenu: function () {
            var tracks = [];
            for (var i = 0; i < this.genomeViewer.trackListPanel.tracks.length; i++) {
                var t = this.genomeViewer.trackListPanel.tracks[i];
                tracks.push(t);
            }
            this.$.trackMenu.set('tracks', tracks);
        },
        _init: function () {
            var me = this;

            this.region = new Region();

            var url = $.url();
            var url_cbhost = url.param('CELLBASE_HOST');
            if (url_cbhost != null) {
                CELLBASE_HOST = url_cbhost;
            }

            this.speciesObj = DEFAULT_SPECIES;
            var urlSpecies = url.param('species');
            if (typeof urlSpecies !== 'undefined' && urlSpecies != '') {
                this.speciesObj = Utils.getSpeciesFromAvailable(AVAILABLE_SPECIES, urlSpecies) || speciesObj;
            }
            this.species = this.speciesObj;
            this.region.load(this.speciesObj.region);

            this.selectedSpecies = this.species;
            //console.log(speciesObj);

            var regionStr = url.param('region');
            if (regionStr != null) {
                this.region.parse(regionStr);
            }

            var urlZoom = parseInt(url.param('zoom'));
            if (isNaN(urlZoom) || urlZoom > 100 || urlZoom < 0) {
                urlZoom = null;
            }

            var urlGene = url.param('gene');
            if (urlGene != null && urlGene != "") {
                this.region.load(this.getRegionByFeature(urlGene, "gene"));
            }
            var urlSnp = url.param('snp');
            if (urlSnp != null && urlSnp != "") {
                this.region.load(this.getRegionByFeature(urlSnp, "snp"));
            }

            var gvConfig = {
                cellBaseHost: CELLBASE_HOST,
                cellBaseVersion: 'v3',
                width: window.innerWidth,
                region: this.region,
                version: this.version,
                availableSpecies: AVAILABLE_SPECIES,
                species: this.speciesObj,
                sidePanel: false,
                resizable: false,
//        quickSearchResultFn:quickSearchResultFn,
//        quickSearchDisplayKey:,
                karyotypePanelConfig: {
                    hidden: true,
                    collapsed: false,
                    collapsible: true
                },
                chromosomePanelConfig: {
                    hidden: false,
                    collapsed: false,
                    collapsible: true
                },
                regionPanelConfig: {
                    hidden: false,
                    collapsed: false,
                    collapsible: true
                },
                drawStatusBar: false,
//            drawNavigationBar: false,
                handlers: {
                    'region:change': function (e) {
                        console.log(e)
                    },
                    'species:change': function (event) {
//            me._setTracks();
//            me.setTracksMenu();
                        var text = me.species.text + ' <span style="color: #8396b2">' + me.species.assembly + '</span>';
                        me.$.description.innerHTML = text;
                        me.set('selectedSpecies', event.species);
//                    me._refreshInitialTracksConfig();
                    }
                }


//        chromosomeList:[]
//            trackListTitle: ''
//            drawNavigationBar = true;
//            drawKaryotypePanel: false,
//            drawChromosomePanel: false,
//            drawOverviewTrackListPanel: false

            };

            this.async(function () {

                this.$.gv.createGenomeViewer(gvConfig);
                this.genomeViewer = this.$.gv.genomeViewer;
                this.genomeViewer.draw();

                this.genomeViewer.trackListPanel.on('tracks:refresh', function (e) {
                    me._updateTrackMenu();
                });
                this.genomeViewer.trackListPanel.on('mousePosition:change', function (event) {
                    me.$.statusBar.set('mousePosition', event);
                });

                //TODO only test; uncomment on production
                this._loadInitialTracksConfig();

            }, 100);

        },


        handleLogin: function () {
            this.selectedOption = "home";

            if (this._lastLogedRequest) {
                this._lastLogedRequest.hidden = false;
                this._lastLogedRequest = null;
            }
        },
        handleLogout: function () {
            this.$.browserPanel.hidden = true;
            this.$.uploadPanel.hidden = true;
        },
        handleUserNeedRefresh: function () {
            this.$.jsoHeader.getUserInfo(true);
        },
        userDataChanged: function (neo, old) {
            var me = this;
            if (this.userData) {
                var projectIds = [];
                for (var i = 0; i < this.userData.projects.length; i++) {
                    var p = this.userData.projects[i];
                    projectIds.push(p.id);
                }
                var projects = [];
                OpencgaManager.projects.studies({
                    id: projectIds.join(','),
                    query: {
                        sid: Cookies("bioinfo_sid")
                    },
                    request: {
                        success: function (response) {
                            if (response.response[0].errorMsg === '' || response.response[0].errorMsg == null) {
                                for (var i = 0; i < response.response.length; i++) {
                                    var r = response.response[i];
                                    me.userData.projects[i].studies = r.result;
                                    projects.push(me.userData.projects[i]);
                                }
                                /* update projects property*/
                                me.projects = projects;
                            } else {
                                console.log(response.error);
                                console.log(response.response[0].errorMsg);
                            }
                            me.loading = false;
                        },
                        error: function () {
                            console.log('Server error, try again later.');
                            me.loading = false;
                        }
                    }
                });
            } else {
                console.log("no user data")
            }
        },


        handleAppMenu: function (e) {
            this.$.sidePanel.classList.toggle('side-panel-shown');
        },
        handleSwapTrackMenu: function (e) {
            this.genomeViewer.trackListPanel.swapTracks(e.detail.t1, e.detail.t2);
        },
        handleResultClick: function (e) {
            this.genomeViewer.setRegion(new Region(e.detail));
        },
        _loadInitialTracksConfig: function () {
            //Load initial TRACKS config
            var categories = TRACKS[SPECIES_TRACKS_GROUP[Utils.getSpeciesCode(this.genomeViewer.species.text)]];
            for (var i = 0, leni = categories.length; i < leni; i++) {
                var category = categories[i];
                var tracks = category.tracks;
                for (var j = 0, lenj = tracks.length; j < lenj; j++) {
                    var track = tracks[j];
                    var trackType = track.id;
                    var checked = track.checked;
                    var disabled = track.disabled;

                    if (checked) {
                        var track = this.addTrack(trackType, trackType);
                    }
                }
            }
//            //update tracks
//            var tracks = [];
//            for (var i = 0; i < this.genomeViewer.trackListPanel.tracks.length; i++) {
//                var track = this.genomeViewer.trackListPanel.tracks[i];
//                tracks.push(track);
//            }
            this.$.trackMenu.tracks = this.genomeViewer.trackListPanel.tracks;
        },
        handleAddTrack: function (e) {
            this.addTrack(e.detail);
            this._updateTrackMenu();
        },
        addTrack: function (trackType, trackTitle, object, host) {
            var me = this;
            var track;
            switch (trackType) {
                case "Sequence":
                    track = new SequenceTrack({
                        title: 'Sequence',
                        height: 25,
                        visibleRegionSize: 200,

                        renderer: new SequenceRenderer(),

                        dataAdapter: new SequenceAdapter({
                            category: "genomic",
                            subCategory: "region",
                            resource: "sequence",
                            species: this.genomeViewer.species
                        })
                    });
                    this.genomeViewer.addTrack(track);
                    break;

                case "Gene/Transcript":
                    track = new GeneTrack({
                        title: 'Gene',
                        minHistogramRegionSize: 20000000,
                        maxLabelRegionSize: 10000000,
                        minTranscriptRegionSize: 200000,
                        height: 100,

                        renderer: new GeneRenderer({
                            handlers: {
                                'feature:click': function (e) {
                                    switch (e.featureType) {
                                        case "gene":
                                            new GeneInfoWidget(null, me.genomeViewer.species).draw(e);
                                            break;
                                        case "transcript":
                                            new TranscriptInfoWidget(null, me.genomeViewer.species).draw(e);
                                            break;
                                        default:
                                            break;
                                    }
                                }
                            }
                        }),

                        dataAdapter: new CellBaseAdapter({
                            category: "genomic",
                            subCategory: "region",
                            resource: "gene",
                            species: this.genomeViewer.species,
                            params: {
                                exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence'
                            },
                            cacheConfig: {
                                chunkSize: 100000,
                                cacheId: "cellbase:gene"
                            }
                        })
                    });
                    this.genomeViewer.addTrack(track);
                    break;
                case "Cytoband":

                    break;
                case "CpG islands":
//            var cpgTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "cpg_island",
//                    species: this.genomeViewer.species,
//                    cacheConfig: {
//                        chunkSize: 50000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(cpgTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 10,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
//            break;
                case "SNP":
                    var renderer = new FeatureRenderer(FEATURE_TYPES.snp);
                    renderer.on('feature:click', function (e) {
                        new SnpInfoWidget(null, me.genomeViewer.species).draw(e);

                    });
                    track = new FeatureTrack({
                        title: 'SNP',
                        featureType: 'SNP',
                        minHistogramRegionSize: 12000,
                        maxLabelRegionSize: 3000,
                        height: 120,

                        renderer: renderer,

                        dataAdapter: new CellBaseAdapter({
                            category: "genomic",
                            subCategory: "region",
                            resource: "snp",
                            params: {
                                exclude: 'transcriptVariations,xrefs,samples'
                            },
                            species: this.genomeViewer.species,
                            cacheConfig: {
                                chunkSize: 10000,
                                cacheId: "cellbase:snp"
                            }
                        })
                    });

                    this.genomeViewer.addTrack(track);


                    break;
                case "Clinical Variants":
//            var mutationTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "mutation",
//                    species: this.genomeViewer.species,
//                    cacheConfig: {
//                        chunkSize: 10000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(mutationTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 50,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });


                    var renderer = new FeatureRenderer(FEATURE_TYPES.clinical);
                    renderer.on('feature:click', function (e) {
                        console.log(e);
                    });
                    track = new FeatureTrack({
                        title: 'Clinical Variants',
                        featureType: 'clinical',
                        minHistogramRegionSize: 12000,
                        maxLabelRegionSize: 3000,
                        visibleRegionSize: 9000,
                        height: 120,

                        renderer: renderer,

                        dataAdapter: new CellBaseAdapter({
                            category: "genomic",
                            subCategory: "region",
                            resource: "clinical",
                            params: {
                                exclude: 'chunkIds'
                            },
                            species: this.genomeViewer.species,
                            cacheConfig: {
                                chunkSize: 10000,
                                cacheId: "cellbase:clinical"
                            }
                        })
                    });

                    this.genomeViewer.addTrack(track);

                    break;

                case "EBI EVA 1.0 SNVs":
                    track = new FeatureTrack({
                        title: 'EVA 1.0 SNVs',
                        featureType: 'eva',
                        minHistogramRegionSize: 10000,
                        maxLabelRegionSize: 3000,
                        height: 100,

                        renderer: new FeatureRenderer({
                            label: function (f) {
                                var title = f.id;
                                if (title == '') {
                                    title = f.chromosome + ":" + f.start + "-" + f.end;
                                }
                                return title;
                            },
                            tooltipTitle: function (f) {
                                var title = f.id;
                                if (title == '') {
                                    title = f.chromosome + ":" + f.start + "-" + f.end;
                                }
                                return f.type + ' - <span style="color:#399697">' + title + '</span>';
                            },
                            tooltipText: function (f) {
                                var str = [
                                    'Location: ' + '<span style="color:#156765">' + f.chromosome + ":" + f.start + "-" + f.end + '</span>',
                                    'Alt. allele: ' + '<span style="color:#156765">' + f.allele + '</span>',
                                    'Variant class: ' + '<span style="color:#156765">' + f.type + '</span>'
                                ];
                                var hgvs = [];
                                for (var key in f.hgvs) {
                                    hgvs.push('<span style="margin-left: 10px">' + Utils.camelCase(key) + '</span>' + ': <span style="color:#156765">' + f.hgvs[key] + '</span>');
                                }
                                if (hgvs.length > 0) {
                                    str.push('HGVS' + '<br><span>' + hgvs.join('<br>') + '</span>');
                                }
                                var files = [];
                                for (var key in f.files) {
                                    files.push('<span style="margin-left: 10px">' + f.files[key].fileId + '</span>' + ' (<span style="color:#156765">' + f.files[key].studyId + '</span>)');
                                }
                                if (files.length > 0) {
                                    str.push('Files (study)' + '<br><span>' + files.join('<br>') + '</span>');
                                }
                                return str.join('<br>');
                            },
                            color: function (f) {
                                return "#399697";
                            },
                            infoWidgetId: "id",
                            height: 10,
                            histogramColor: "#399697",
                            handlers: {
                                'feature:mouseover': function (e) {
                                    // e.feature
                                    console.log(e);
                                }
                            }
                        }),
                        dataAdapter: new EvaAdapter({
                            host: 'http://wwwdev.ebi.ac.uk/eva/webservices/rest',
                            version: 'v1',
                            category: "segments",
                            resource: "variants",
                            params: {
                                exclude: 'sourceEntries',
                                species: Utils.getSpeciesCode(this.genomeViewer.species.text) + '_' + this.genomeViewer.species.assembly.split('.')[0].toLowerCase()
                            },
                            cacheConfig: {
                                chunkSize: 10000,
                                cacheId: "cellbase:evasnv"
                            }
                        })
                    })
                    this.genomeViewer.addTrack(track);
                    break;
                case "Structural variation (<20Kb)":
//            var structuralTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "structural_variation",
//                    species: this.genomeViewer.species,
//                    params: {min_length: 1, max_length: 20000},
//                    cacheConfig: {
//                        chunkSize: 50000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(structuralTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 40,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
                    break;
                case "Structural variation (>20Kb)":
//            var structuralTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "structural_variation",
//                    species: this.genomeViewer.species,
//                    params: {min_length: 20000, max_length: 300000000},
//                    cacheConfig: {
//                        chunkSize: 5000000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(structuralTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 40,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
                    break;
                case "miRNA targets":
                    console.log("TODO :  miRNA targets ")
//            var miRNATrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: 'regulatory',
//                    params: {
//                        type: 'mirna_target'
//                    },
//                    species: this.genomeViewer.species,
//            cacheConfig: {
//                chunkSize: 10000
//            }
//                })
//            });
//            this.genomeViewer.addTrack(miRNATrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 0,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
                    break;
                case "Regulatory":


                    track = new FeatureTrack({
                        title: 'Regulatory',
                        minHistogramRegionSize: 12000,
                        maxLabelRegionSize: 3000,
                        height: 120,
//                        renderer: new FeatureRenderer({
//                            label: function (f) {
//                                return ('name' in f) ? f.name : f.id;
//                            },
//                            tooltipTitle: function (f) {
//                                var name = ('name' in f) ? f.name : f.id;
//                                return f.featureType.toUpperCase() + ' - <span class="ok">' + name + '</span>';
//                            },
//                            tooltipText: function (f) {
//                                return 'matrix:&nbsp;<span class="ssel">' + f.matrix + '</span><br>' +
//                                        'score:&nbsp;<span class="ssel">' + f.score + '</span><br>' +
//                                        FEATURE_TYPES.getTipCommons(f) +
//                                        'source:&nbsp;<span class="ssel">' + f.source + '</span><br>';
//
//                            },
//                            color: 'lightblue',
//                            infoWidgetId: "id",
//                            height: 8,
//                            histogramColor: "orange",
//                            handlers: {
//                                'feature:mouseover': function (e) {
//                                    console.log(e)
//                                },
//                                'feature:click': function (event) {
//                                    new SnpInfoWidget(null, me.genomeViewer.species).draw(event);
//                                }
//                            }
//                        }),

                        renderer: new FeatureRenderer(FEATURE_TYPES.regulatory),

                        dataAdapter: new CellBaseAdapter({
                            category: "genomic",
                            subCategory: "region",
                            resource: "regulatory",
                            species: this.genomeViewer.species,
                            params: {
                                exclude: '_chunkIds,chunkIds'
                            },
                            cacheConfig: {
                                chunkSize: 50000,
                                cacheId: "cellbase:regulatory"
                            }
                        })
                    });

                    this.genomeViewer.addTrack(track);
                    break;

//	case "Histone":
//
//		break;
//	case "Polymerase":
//
//		break;
//	case "Open Chromatin":
//
//		break;
                case "Conserved regions":
                    track = new FeatureTrack({
//                targetId: null,
//                id: id,
//                title: 'Conserved Region',
//                histogramZoom: 0,
//                labelZoom: 80,
//                height: 120,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES,
//                renderer: new ConservedRenderer({
//                    label: function (f) {
//                        return f.chromosome + ":" + f.start + "-" + f.end;
//                    },
//                    tooltipTitle: function (f) {
//                        var name = (f.name != null) ? f.name : f.id;
//                        return f.featureType.toUpperCase() + ' - <span class="ok">' + name + '</span>';
//                    },
//                    tooltipText: function (f) {
//                        return 'alleles:&nbsp;<span class="ssel">' + f.alleleString + '</span><br>' +
//                            FEATURE_TYPES.getTipCommons(f) +
//                            'source:&nbsp;<span class="ssel">' + f.source + '</span><br>';
//
//                    },
//                    color: 'lightblue',
//                    infoWidgetId: "id",
//                    height: 8,
//                    histogramColor: "orange",
//                    handlers: {
//                        'feature:mouseover': function (e) {
//                            console.log(e)
//                        },
//                        'feature:click': function (event) {
//                            new SnpInfoWidget(null, _this.genomeViewer.species).draw(event);
//                        }
//                    }
//                }),
//
//                dataAdapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "conserved_region",
//                    params: {
//                    },
//                    cacheConfig: {
//                        chunkSize: 10000
//                    }
//                })
                    });

                    this.genomeViewer.addTrack(track);
                    break;
//            var conservedTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "conserved_region2",
//                    species: this.genomeViewer.species,
//                    featureCache: {
//                        gzip: true,
//                        chunkSize: 10000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(conservedTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 50,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
                case "bam":
                case "ALIGNMENT":
                    var adapter = new OpencgaAdapter({
                        category: "ALIGNMENT",
                        host: host,
                        resource: object,
                        species: this.genomeViewer.species,
                        params: {
                            sid: Cookies('bioinfo_sid')
                        },
                        cacheConfig: {
                            chunkSize: 5000,
                            cacheId: Cookies('bioinfo_sid') + 'opencga' + object.id,
                        }
                    });
                    var renderer = new BamRenderer(FEATURE_TYPES.bam);

                    track = new BamTrack({
                        title: trackTitle,
                        closable: true,
                        //minHistogramRegionSize: 12000,
                        //maxLabelRegionSize: 3000,
                        //visibleRegionSize: 9000,
                        height: 150,
                        renderer: renderer,
                        dataAdapter: adapter
                    });
                    this.genomeViewer.addTrack(track);
                    break;

                case "vcf":
                case "VARIANT":

                    //category: "genomic",
                    //subCategory: "region",
                    //resource: "tfbs",
                    //species: this.genomeViewer.species,
                    //params: {},
                    //cacheConfig: {
                    //    chunkSize: 50000,
                    //    cacheId: "cellbase:tfbs"
                    //}


                    var adapter = new OpencgaAdapter({
                        category: "VARIANT",
                        host: host,
                        resource: object,
                        species: this.genomeViewer.species,
                        params: {
                            sid: Cookies('bioinfo_sid')
                        },
                        cacheConfig: {
                            chunkSize: 50000,
                            cacheId: Cookies('bioinfo_sid') + 'opencga' + object.id,
                        }
                    });
//            var renderer = new FeatureRenderer('vcf');
//            renderer.on({
//                'feature:click': function (event) {
//
//                    var vcfInfo = new VCFVariantInfoWidget(null, _this.genomeViewer.species, {adapter: adapter}).draw(event);
//                }
//            });
                    var renderer = new VcfMultisampleRenderer(FEATURE_TYPES.vcf);
                    renderer.on({
                        'feature:click': function (event) {
                            var vcfInfo = new VCFVariantInfoWidget(null, me.genomeViewer.species, {adapter: adapter}).draw(event);
                        }
                    });

                    track = new FeatureTrack({
                        title: trackTitle,
                        closable: true,
                        //minHistogramRegionSize: 12000,
                        //maxLabelRegionSize: 3000,
                        //visibleRegionSize: 9000,
                        height: 150,
                        renderer: renderer,
                        dataAdapter: adapter
                    });
                    this.genomeViewer.addTrack(track);
                    break;

                default:
                    return null;
            }
            return track;
        }
    });
</script>


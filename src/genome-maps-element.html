<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-fontawesome/polymer-fontawesome.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-header.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-project-browser.html">
<link rel="import" href="components/gm-track-menu.html">
<link rel="import" href="components/gm-search.html">
<link rel="import" href="components/gm-add-track.html">
<link rel="import" href="components/gm-import-data.html">

<polymer-element name="genome-maps-element">
<template>
    <link rel="stylesheet" href="../lib/jsorolla/styles/css/style.css">
    <link rel="stylesheet" href="../bower_components/fontawesome/css/font-awesome.min.css">
    <style>
        :host {
            display: block;
            position: relative;
            height: 100%;
            background-color: #314559;

            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;

            font-size: 13px;
        }

        #home {
            position: relative;
            box-sizing: border-box;
            background-color: #FFFFFF;
        }

        div.side-panel {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            z-index: 200000;
            top: 33px;
            right: 0px;
            width: 350px;
            margin: 0;
            padding: 0;
            background: white;
            /*border: 1px solid #c6d0da;*/
            /*border-right-width: 0px;*/
            transition: all 0.2s;
        }

        div.side-panel-shown {
            visibility: visible !important;
            opacity: 1 !important;
        }

        [hide=true] {
            display: none !important;
        }

        jso-project-browser {
            position: absolute;
            top: 60px; /* header height */
            bottom: 0;
            left: 0;
            right: 0;
        }


    </style>
    <jso-header selectedOption="{{selectedOption}}" userData="{{userData}}" title="Genome Maps">

    </jso-header>

    <div id="home" hide="{{selectedOption != 'home'}}">
        <div id="genomeViewer">
            <div id="sidePanel" class="side-panel">
                <gm-track-menu id="trackMenu" on-swap="{{handleSwapTrackMenu}}" genomeViewer="{{genomeViewer}}"></gm-track-menu>
                <gm-search id="search" selectedSpecies="{{selectedSpecies}}" collapsed="true"
                           on-feature="{{handleResultClick}}"></gm-search>
                <gm-add-track id="addTrack" selectedSpecies="{{selectedSpecies}}" collapsed="true"></gm-add-track>
                <gm-import-data id="importData" userData="{{userData}}" genomeViewer="{{genomeViewer}}"
                                selectedSpecies="{{selectedSpecies}}"></gm-import-data>
            </div>
        </div>
    </div>

    <jso-project-browser userData="{{userData}}" selectedProject="{{selectedProject}}" selectedStudy="{{selectedStudy}}"
                         hide="{{selectedOption != 'projects' }}"></jso-project-browser>

</template>
<script>
Polymer({
    created: function () {
        this.selectedOption = 'home';
        this.userData;
        this.genomeViewer;

        this.selectedProject;
        this.selectedStudy;

        this.selectedSpecies = DEFAULT_SPECIES;
        this.region = new Region();
        this.region.load(this.selectedSpecies.region);
        this.region.load("20:59993");
    },
    ready: function () {
        this.createGenomeViewer();
        this._loadInitialTracksConfig();
        this.genomeViewer.draw();

    },
    handleAppMenu: function (e) {
        this.$.sidePanel.classList.toggle('side-panel-shown');
    },
    handleSwapTrackMenu: function (e) {
        this.genomeViewer.trackListPanel.swapTracks(e.detail.t1, e.detail.t2);
    },
    handleResultClick: function (e) {
        this.genomeViewer.setRegion(new Region(e.detail));
    },
    createGenomeViewer: function () {
        var me = this;
        this.genomeViewer = new GenomeViewer({
            cellBaseHost: 'https://www.ebi.ac.uk/cellbase/webservices/rest',
            cellBaseVersion: 'v3',
            target: this.$.genomeViewer,
            width: this.getBoundingClientRect().width,
            region: this.region,
            version: this.version,
            availableSpecies: AVAILABLE_SPECIES,
            species: this.selectedSpecies,
            sidePanel: false,
//            resizable: true,
            resizable: false,
//        quickSearchResultFn:quickSearchResultFn,
//        quickSearchDisplayKey:,
            karyotypePanelConfig: {
                hidden: true,
                collapsed: false,
                collapsible: true
            },
            chromosomePanelConfig: {
                hidden: false,
                collapsed: false,
                collapsible: true
            },
            regionPanelConfig: {
                hidden: false,
                collapsed: false,
                collapsible: true
            },
            drawStatusBar: true,
//            drawNavigationBar: false,
            navigationBarConfig: {
                componentsConfig: {
                    menuButton: true,
//                    leftSideButton:true,
//                restoreDefaultRegionButton:false,
//                regionHistoryButton:false,
//                speciesButton:false,
//                chromosomesButton:false,
//                karyotypeButton:false,
//                chromosomeButton:false,
//                regionButton:false,
//                zoomControl:false,
//                windowSizeControl:false,
//                positionControl:false,
//                moveControl:false,
//                autoheightButton:false,
//                compactButton:false,
//                searchControl:false,
                }
            },
            handlers: {
                'region:change': function (e) {
                    console.log(e)
                },
                'species:change': function (event) {
//            _this._setTracks();
//            _this.setTracksMenu();
                    _this.species = event.species;
                    var text = _this.species.text + ' <span style="color: #8396b2">' + _this.species.assembly + '</span>';
                    _this.headerWidget.setDescription(text);
//                    _this._refreshInitialTracksConfig();
                }
            }
//        chromosomeList:[]
//            trackListTitle: ''
//            drawNavigationBar = true;
//            drawKaryotypePanel: false,
//            drawChromosomePanel: false,
//            drawOverviewTrackListPanel: false

        });

        this.genomeViewer.navigationBar.on('menuButton:click', function (e) {
            me.handleAppMenu();
//                if (me.genomeViewer.sidePanel.isVisible()) {
//                    me.genomeViewer.hide();
//                } else {
//                    me.genomeViewer.show();
//                }
        });

//        var genomeViewer = new GenomeViewer({
//            height: this.height - this.headerWidget.height,
//            width: this.width-18,
//            }
//        });


        var renderer = new FeatureRenderer(FEATURE_TYPES.gene);
        renderer.on({
            'feature:click': function (event) {
                // feature click event example
                console.log(event)
                new GeneInfoWidget(null, _this.species).draw(event);
            }
        });
        var gene = new FeatureTrack({
//        title: 'Gene overview',
            minHistogramRegionSize: 20000000,
            maxLabelRegionSize: 10000000,
            height: 100,

            renderer: renderer,

            dataAdapter: new CellBaseAdapter({
                category: "genomic",
                subCategory: "region",
                resource: "gene",
                params: {
                    exclude: 'transcripts,chunkIds'
                },
                species: this.genomeViewer.species,
                cacheConfig: {
                    chunkSize: 100000
                }
            })
        });
        this.genomeViewer.addOverviewTrack(gene);

        return this.genomeViewer;
    },
    _loadInitialTracksConfig: function () {
        //Load initial TRACKS config
        var categories = TRACKS[SPECIES_TRACKS_GROUP[Utils.getSpeciesCode(this.genomeViewer.species.text)]];
        for (var i = 0, leni = categories.length; i < leni; i++) {
            var category = categories[i];
            var tracks = category.tracks;
            for (var j = 0, lenj = tracks.length; j < lenj; j++) {
                var track = tracks[j];
                var trackType = track.id;
                var checked = track.checked;
                var disabled = track.disabled;

                if (checked) {
                    var track = this.addTrack(trackType, trackType);
                }
            }
        }
        this.$.trackMenu.tracks = this.genomeViewer.trackListPanel.tracks;
    },
    addTrack: function (trackType, trackTitle, object, host) {
        var _this = this;
        var track;
        switch (trackType) {
            case "Sequence":
                track = new SequenceTrack({
                    title: 'Sequence',
                    height: 25,
                    visibleRegionSize: 200,

                    renderer: new SequenceRenderer(),

                    dataAdapter: new SequenceAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "sequence",
                        species: this.genomeViewer.species
                    })
                });
                this.genomeViewer.addTrack(track);
                break;

            case "Gene/Transcript":
                track = new GeneTrack({
                    title: 'Gene',
                    minHistogramRegionSize: 20000000,
                    maxLabelRegionSize: 10000000,
                    minTranscriptRegionSize: 200000,
                    height: 100,

                    renderer: new GeneRenderer({
                        handlers: {
                            'feature:click': function (e) {
                                switch (e.featureType) {
                                    case "gene":
                                        new GeneInfoWidget(null, _this.genomeViewer.species).draw(e);
                                        break;
                                    case "transcript":
                                        new TranscriptInfoWidget(null, _this.genomeViewer.species).draw(e);
                                        break;
                                    default:
                                        break;
                                }
                            }
                        }
                    }),

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "gene",
                        species: this.genomeViewer.species,
                        params: {
                            exclude: 'transcripts.tfbs,transcripts.xrefs,transcripts.exons.sequence'
                        },
                        cacheConfig: {
                            chunkSize: 100000,
                            cacheId: "cellbase:gene"
                        }
                    })
                });
                this.genomeViewer.addTrack(track);
                break;
            case "Cytoband":

                break;
            case "CpG islands":
//            var cpgTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "cpg_island",
//                    species: this.genomeViewer.species,
//                    cacheConfig: {
//                        chunkSize: 50000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(cpgTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 10,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
//            break;
            case "SNP":
                var renderer = new FeatureRenderer(FEATURE_TYPES.snp);
                renderer.on('feature:click', function (e) {
                    new SnpInfoWidget(null, _this.genomeViewer.species).draw(e);

                });
                track = new FeatureTrack({
                    title: 'SNP',
                    featureType: 'SNP',
                    minHistogramRegionSize: 12000,
                    maxLabelRegionSize: 3000,
                    height: 120,

                    renderer: renderer,

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "snp",
                        params: {
                            exclude: 'transcriptVariations,xrefs,samples'
                        },
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            chunkSize: 10000,
                            cacheId: "cellbase:snp"
                        }
                    })
                });

                this.genomeViewer.addTrack(track);


                break;
            case "Mutation":
//            var mutationTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "mutation",
//                    species: this.genomeViewer.species,
//                    cacheConfig: {
//                        chunkSize: 10000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(mutationTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 50,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });


                var renderer = new FeatureRenderer(FEATURE_TYPES.mutation);
                renderer.on('feature:click', function (e) {
                    console.log(e);
                });
                track = new FeatureTrack({
                    title: 'Mutation',
                    featureType: 'mutation',
                    minHistogramRegionSize: 12000,
                    maxLabelRegionSize: 3000,
                    visibleRegionSize: 9000,
                    height: 120,

                    renderer: renderer,

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "mutation",
                        params: {
                            exclude: 'chunkIds'
                        },
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            chunkSize: 10000,
                            cacheId: "cellbase:mutation"
                        }
                    })
                });

                this.genomeViewer.addTrack(track);

                break;

            case "EBI EVA 1.0 SNVs":
                track = new FeatureTrack({
                    title: 'EVA 1.0 SNVs',
                    minHistogramRegionSize: 10000,
                    visibleRegionSize: 9000,
                    maxLabelRegionSize: 3000,
                    height: 100,

                    renderer: new FeatureRenderer({
                        label: function (f) {
                            var title = f.id;
                            if (title == '') {
                                title = f.chromosome + ":" + f.start + "-" + f.end;
                            }
                            return title;
                        },
                        tooltipTitle: function (f) {
                            var title = f.id;
                            if (title == '') {
                                title = f.chromosome + ":" + f.start + "-" + f.end;
                            }
                            return f.type + ' - <span style="color:#399697">' + title + '</span>';
                        },
                        tooltipText: function (f) {
                            var str = [
                                        'Location: ' + '<span style="color:#156765">' + f.chromosome + ":" + f.start + "-" + f.end + '</span>',
                                        'Alt. allele: ' + '<span style="color:#156765">' + f.allele + '</span>',
                                        'Variant class: ' + '<span style="color:#156765">' + f.type + '</span>'
                            ];
                            var hgvs = [];
                            for (var key in f.hgvs) {
                                hgvs.push('<span style="margin-left: 10px">' + Utils.camelCase(key) + '</span>' + ': <span style="color:#156765">' + f.hgvs[key] + '</span>');
                            }
                            if (hgvs.length > 0) {
                                str.push('HGVS' + '<br><span>' + hgvs.join('<br>') + '</span>');
                            }
                            var files = [];
                            for (var key in f.files) {
                                files.push('<span style="margin-left: 10px">' + f.files[key].fileId + '</span>' + ' (<span style="color:#156765">' + f.files[key].studyId + '</span>)');
                            }
                            if (files.length > 0) {
                                str.push('Files (study)' + '<br><span>' + files.join('<br>') + '</span>');
                            }
                            return str.join('<br>');
                        },
                        color: function (f) {
                            return "#399697";
                        },
                        infoWidgetId: "id",
                        height: 10,
                        histogramColor: "#399697",
                        handlers: {
                            'feature:mouseover': function (e) {
//                        e.feature
                                console.log(e);
                            }
                        }
                    }),

                    dataAdapter: new EvaAdapter({
                        host: 'http://wwwdev.ebi.ac.uk/eva/webservices/rest',
                        version: 'v1',
                        category: "segments",
                        resource: "variants",
                        params: {
                            exclude: 'files'
                        },
                        cacheConfig: {
                            chunkSize: 10000,
                            cacheId: "cellbase:evasnv"
                        }
                    })
                })
                this.genomeViewer.addTrack(track);
                break;
            case "Structural variation (<20Kb)":
//            var structuralTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "structural_variation",
//                    species: this.genomeViewer.species,
//                    params: {min_length: 1, max_length: 20000},
//                    cacheConfig: {
//                        chunkSize: 50000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(structuralTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 40,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
                break;
            case "Structural variation (>20Kb)":
//            var structuralTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "structural_variation",
//                    species: this.genomeViewer.species,
//                    params: {min_length: 20000, max_length: 300000000},
//                    cacheConfig: {
//                        chunkSize: 5000000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(structuralTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 40,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
                break;
            case "miRNA targets":
                console.log("TODO :  miRNA targets ")
//            var miRNATrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: 'regulatory',
//                    params: {
//                        type: 'mirna_target'
//                    },
//                    species: this.genomeViewer.species,
//            cacheConfig: {
//                chunkSize: 10000
//            }
//                })
//            });
//            this.genomeViewer.addTrack(miRNATrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 0,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
//            break;
            case "TFBS":

                track = new FeatureTrack({
                    title: 'TFBS',
                    minHistogramRegionSize: 12000,
                    maxLabelRegionSize: 3000,
                    height: 120,
                    renderer: new FeatureRenderer({
                        label: function (f) {
                            return ('name' in f) ? f.name : f.id;
                        },
                        tooltipTitle: function (f) {
                            var name = ('name' in f) ? f.name : f.id;
                            return f.featureType.toUpperCase() + ' - <span class="ok">' + name + '</span>';
                        },
                        tooltipText: function (f) {
                            return 'matrix:&nbsp;<span class="ssel">' + f.matrix + '</span><br>' +
                                    'score:&nbsp;<span class="ssel">' + f.score + '</span><br>' +
                                    FEATURE_TYPES.getTipCommons(f) +
                                    'source:&nbsp;<span class="ssel">' + f.source + '</span><br>';

                        },
                        color: 'lightblue',
                        infoWidgetId: "id",
                        height: 8,
                        histogramColor: "orange",
                        handlers: {
                            'feature:mouseover': function (e) {
                                console.log(e)
                            },
                            'feature:click': function (event) {
                                new SnpInfoWidget(null, _this.genomeViewer.species).draw(event);
                            }
                        }
                    }),

                    dataAdapter: new CellBaseAdapter({
                        category: "genomic",
                        subCategory: "region",
                        resource: "tfbs",
                        species: this.genomeViewer.species,
                        params: {
                        },
                        cacheConfig: {
                            chunkSize: 50000,
                            cacheId: "cellbase:tfbs"
                        }
                    })
                });

                this.genomeViewer.addTrack(track);
                break;

//	case "Histone":
//
//		break;
//	case "Polymerase":
//
//		break;
//	case "Open Chromatin":
//
//		break;
            case "Conserved regions":
                track = new FeatureTrack({
//                targetId: null,
//                id: id,
//                title: 'Conserved Region',
//                histogramZoom: 0,
//                labelZoom: 80,
//                height: 120,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES,
//                renderer: new ConservedRenderer({
//                    label: function (f) {
//                        return f.chromosome + ":" + f.start + "-" + f.end;
//                    },
//                    tooltipTitle: function (f) {
//                        var name = (f.name != null) ? f.name : f.id;
//                        return f.featureType.toUpperCase() + ' - <span class="ok">' + name + '</span>';
//                    },
//                    tooltipText: function (f) {
//                        return 'alleles:&nbsp;<span class="ssel">' + f.alleleString + '</span><br>' +
//                            FEATURE_TYPES.getTipCommons(f) +
//                            'source:&nbsp;<span class="ssel">' + f.source + '</span><br>';
//
//                    },
//                    color: 'lightblue',
//                    infoWidgetId: "id",
//                    height: 8,
//                    histogramColor: "orange",
//                    handlers: {
//                        'feature:mouseover': function (e) {
//                            console.log(e)
//                        },
//                        'feature:click': function (event) {
//                            new SnpInfoWidget(null, _this.genomeViewer.species).draw(event);
//                        }
//                    }
//                }),
//
//                dataAdapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "conserved_region",
//                    params: {
//                    },
//                    cacheConfig: {
//                        chunkSize: 10000
//                    }
//                })
                });

                this.genomeViewer.addTrack(track);
                break;
//            var conservedTrack = new TrackData(id, {
//                adapter: new CellBaseAdapter({
//                    category: "genomic",
//                    subCategory: "region",
//                    resource: "conserved_region2",
//                    species: this.genomeViewer.species,
//                    featureCache: {
//                        gzip: true,
//                        chunkSize: 10000
//                    }
//                })
//            });
//            this.genomeViewer.addTrack(conservedTrack, {
//                id: id,
//                type: trackType,
//                title: trackTitle,
//                featuresRender: "MultiFeatureRender",
//                histogramZoom: 50,
//                height: 150,
//                visibleRange: {start: 0, end: 100},
//                featureTypes: FEATURE_TYPES
//            });
            case "bam":

                track = new BamTrack({
                    title: trackTitle,
                    height: 200,
                    visibleRegionSize: 100000,

                    renderer: new BamRenderer(FEATURE_TYPES.bam),

                    dataAdapter: new BamAdapter({
                        category: "bam",
                        host: host,
                        resource: object,
                        species: this.genomeViewer.species,
                        cacheConfig: {
                            chunkSize: 5000
                        }
                    })
                });
                this.genomeViewer.addTrack(track);
                break;


            case "vcf":

                var adapter = new OpencgaAdapter({
                    category: "vcf",
                    host: host,
                    resource: object,
                    species: this.genomeViewer.species,
                    cacheConfig: {
                        chunkSize: 5000
                    }
                });
//            var renderer = new FeatureRenderer('vcf');
//            renderer.on({
//                'feature:click': function (event) {
//
//                    var vcfInfo = new VCFVariantInfoWidget(null, _this.genomeViewer.species, {adapter: adapter}).draw(event);
//                }
//            });
                var renderer = new VcfMultisampleRenderer(FEATURE_TYPES.vcf);
                renderer.on({
                    'feature:click': function (event) {
                        var vcfInfo = new VCFVariantInfoWidget(null, _this.genomeViewer.species, {adapter: adapter}).draw(event);
                    }
                });

                track = new FeatureTrack({
                    targetId: null,
                    id: id,
                    title: trackTitle,
                    histogramZoom: 0,
                    height: 150,
                    autoHeight: false,
                    visibleRange: {start: 60, end: 100},
                    labelZoom: 100,
                    renderer: renderer,
                    dataAdapter: adapter
                });
                this.genomeViewer.addTrack(track);
                break;

            default:
                return null;
        }
        return track;
    }
});
</script>
</polymer-element>
